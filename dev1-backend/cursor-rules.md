# ü§ñ CURSOR RULES - BACKEND DEVELOPER

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!

**–≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ò–ò-—Å–µ—Å—Å–∏–∏. –ù–∞—Ä—É—à–µ–Ω–∏–µ = –ø—Ä–æ–≤–∞–ª —Å–µ—Å—Å–∏–∏!**

---

## üìã –ü–ï–†–ï–î –ù–ê–ß–ê–õ–û–ú –°–ï–°–°–ò–ò

### 1. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ß–¢–ï–ù–ò–ï:
- `/dev1-backend/architecture.md` - backend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `/dev1-backend/session-plan.md` - –ø–ª–∞–Ω —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω –∏–∑ `/dev1-backend/templates/`

### 2. –ü–†–û–í–ï–†–ò–¢–¨ –ö–û–ù–¢–ï–ö–°–¢:
- –ö–∞–∫–æ–π —Å–ª–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º?
- –ö–∞–∫–∏–µ –º–æ–¥–µ–ª–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º?
- –ï—Å—Ç—å –ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤?

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´

### –°–õ–û–ï–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê - –°–¢–†–û–ì–û!
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  TELEGRAM BOT   ‚îÇ ‚Üê –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   REST API      ‚îÇ ‚Üê API —Å–ª–æ–π
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   SERVICES      ‚îÇ ‚Üê –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  REPOSITORIES   ‚îÇ ‚Üê –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ GOOGLE SHEETS   ‚îÇ ‚Üê –•—Ä–∞–Ω–∏–ª–∏—â–µ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üö´ –ó–ê–ü–†–ï–©–ï–ù–û:
- –ü—Ä—è–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –º–µ–∂–¥—É –Ω–µ—Å–æ—Å–µ–¥–Ω–∏–º–∏ —Å–ª–æ—è–º–∏
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ handlers/controllers
- –ü—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ Google Sheets –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –°–∏–Ω–≥–ª—Ç–æ–Ω—ã (–∫—Ä–æ–º–µ config)

### ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
- Dependency Injection —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- –ü—Ä–æ—Ç–æ–∫–æ–ª—ã (ABC) –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- Async/await –¥–ª—è –≤—Å–µ—Ö I/O –æ–ø–µ—Ä–∞—Ü–∏–π
- Type hints –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üìù –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –®–ê–ë–õ–û–ù–´

### Backend Service Pattern:
```python
from abc import ABC, abstractmethod
from typing import List, Optional
from ..models.client import Client, ClientCreateData
from ..repositories.protocols.client_repository import ClientRepositoryProtocol
from ..utils.logger import get_logger
from ..utils.exceptions import ValidationError, BusinessLogicError

logger = get_logger(__name__)

class ClientServiceProtocol(ABC):
    @abstractmethod
    async def create_client(self, data: ClientCreateData) -> Client: ...

class ClientService(ClientServiceProtocol):
    def __init__(self, repository: ClientRepositoryProtocol):
        self.repository = repository
    
    async def create_client(self, data: ClientCreateData) -> Client:
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏."""
        logger.info(f"Creating client: {data.phone}")
        
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            self._validate_client_data(data)
            
            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
            client = await self.repository.save_client(data)
            
            logger.info(f"Client created: {client.id}")
            return client
            
        except ValidationError as e:
            logger.error(f"Validation failed: {e}")
            raise
        except Exception as e:
            logger.critical(f"Unexpected error: {e}")
            raise IntegrationError("Failed to create client")
```

### Repository Pattern:
```python
from abc import ABC, abstractmethod
from typing import List, Optional
from ..models.client import Client, ClientCreateData

class ClientRepositoryProtocol(ABC):
    @abstractmethod
    async def save_client(self, data: ClientCreateData) -> Client: ...
    
    @abstractmethod
    async def get_client_by_phone(self, phone: str) -> Optional[Client]: ...

class GoogleSheetsClientRepository(ClientRepositoryProtocol):
    def __init__(self, sheets_client: GoogleSheetsClient):
        self.sheets_client = sheets_client
    
    async def save_client(self, data: ClientCreateData) -> Client:
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Google Sheets
        pass
```

### Telegram Handler Pattern:
```python
from telegram import Update
from telegram.ext import ContextTypes
from ..services.protocols.client_service import ClientServiceProtocol
from ..utils.logger import get_logger

logger = get_logger(__name__)

class ClientRegistrationHandler:
    def __init__(self, client_service: ClientServiceProtocol):
        self.client_service = client_service
    
    async def handle_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
        user = update.effective_user
        logger.info(f"User started registration: {user.id}")
        
        try:
            # –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            await update.message.reply_text("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?")
            return WAITING_NAME
            
        except Exception as e:
            logger.error(f"Error in start handler: {e}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            return ConversationHandler.END
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### Unit Test Pattern:
```python
import pytest
from unittest.mock import Mock, AsyncMock
from src.services.client_service import ClientService
from src.models.client import ClientCreateData, Client

class TestClientService:
    def setup_method(self):
        self.mock_repository = Mock()
        self.service = ClientService(self.mock_repository)
    
    @pytest.mark.asyncio
    async def test_create_client_success(self):
        # Arrange
        client_data = ClientCreateData(name="Test", phone="+79991234567")
        expected_client = Client(id="123", **client_data.__dict__)
        self.mock_repository.save_client = AsyncMock(return_value=expected_client)
        
        # Act
        result = await self.service.create_client(client_data)
        
        # Assert
        assert result.name == client_data.name
        self.mock_repository.save_client.assert_called_once_with(client_data)
```

### Integration Test Pattern:
```python
import pytest
from src.integrations.google_sheets import GoogleSheetsClient
from src.repositories.client_repository import GoogleSheetsClientRepository

@pytest.mark.integration
class TestGoogleSheetsIntegration:
    @pytest.fixture
    def repository(self):
        sheets_client = GoogleSheetsClient(test_config)
        return GoogleSheetsClientRepository(sheets_client)
    
    @pytest.mark.asyncio
    async def test_save_and_retrieve_client(self, repository):
        # –¢–µ—Å—Ç —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Google Sheets
        pass
```

---

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### Environment Variables Pattern:
```python
from pydantic import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # Telegram
    telegram_bot_token: str
    telegram_admin_chat_id: int
    
    # Google Sheets
    google_sheets_id: str
    google_credentials_path: str
    
    # API
    api_host: str = "localhost"
    api_port: int = 8000
    debug: bool = False
    
    class Config:
        env_file = ".env"

settings = Settings()
```

---

## üìä –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:
```python
import logging
from typing import Any, Dict

def get_logger(name: str) -> logging.Logger:
    """–°–æ–∑–¥–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä."""
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    formatter = logging.Formatter(
        '[%(asctime)s] [%(levelname)s] [%(name)s] %(message)s'
    )
    
    return logger

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
logger = get_logger(__name__)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
logger.info(f"Starting operation: {operation_name}", extra={
    "user_id": user_id,
    "operation": operation_name
})
```

### –ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:
- –ù–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü –≤—Å–µ—Ö async –æ–ø–µ—Ä–∞—Ü–∏–π
- –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–±–µ–∑ sensitive –¥–∞–Ω–Ω—ã—Ö)
- –û—à–∏–±–∫–∏ —Å –ø–æ–ª–Ω—ã–º traceback
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ API
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –±–æ—Ç–µ

---

## üõ°Ô∏è –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö

### –ò–µ—Ä–∞—Ä—Ö–∏—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
```python
class PrakritiException(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    pass

class ValidationError(PrakritiException):
    """–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö."""
    pass

class BusinessLogicError(PrakritiException):
    """–ù–∞—Ä—É—à–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª."""
    pass

class IntegrationError(PrakritiException):
    """–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏."""
    pass
```

### –ü–∞—Ç—Ç–µ—Ä–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```python
try:
    result = await service.do_something()
    return result
except ValidationError as e:
    logger.error(f"Validation failed: {e}")
    raise  # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º validation –æ—à–∏–±–∫–∏
except BusinessLogicError as e:
    logger.error(f"Business logic error: {e}")
    raise  # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º business –æ—à–∏–±–∫–∏
except Exception as e:
    logger.critical(f"Unexpected error: {e}")
    raise IntegrationError("Operation failed")
```

---

## üéØ TELEGRAM BOT –°–ü–ï–¶–ò–§–ò–ö–ê

### State Machine Pattern:
```python
from enum import Enum
from telegram.ext import ConversationHandler

class RegistrationState(Enum):
    WAITING_NAME = "waiting_name"
    WAITING_PHONE = "waiting_phone"
    WAITING_EXPERIENCE = "waiting_experience"
    WAITING_INTENSITY = "waiting_intensity"
    WAITING_TIME = "waiting_time"

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ handlers
async def handle_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> str:
    user_name = update.message.text
    context.user_data['name'] = user_name
    
    await update.message.reply_text("–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:")
    return RegistrationState.WAITING_PHONE.value
```

### Keyboard Pattern:
```python
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

def create_yes_no_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –î–∞/–ù–µ—Ç."""
    keyboard = [
        [
            InlineKeyboardButton("–î–∞", callback_data="yes"),
            InlineKeyboardButton("–ù–µ—Ç", callback_data="no")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)
```

---

## üìÖ –ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß

### APScheduler Pattern:
```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from datetime import datetime, timedelta

class ReminderScheduler:
    def __init__(self, notification_service: NotificationServiceProtocol):
        self.notification_service = notification_service
        self.scheduler = AsyncIOScheduler()
    
    def start(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫."""
        self.scheduler.start()
    
    async def schedule_class_reminder(self, client_id: str, class_datetime: datetime):
        """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–Ω—è—Ç–∏–∏."""
        reminder_time = class_datetime - timedelta(hours=2)
        
        self.scheduler.add_job(
            self._send_class_reminder,
            trigger='date',
            run_date=reminder_time,
            args=[client_id, class_datetime],
            id=f"reminder_{client_id}_{class_datetime.isoformat()}"
        )
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ó–ê–í–ï–†–®–ï–ù–ò–Ø –°–ï–°–°–ò–ò

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- [ ] –í—Å–µ –º–µ—Ç–æ–¥—ã –∏–º–µ—é—Ç type hints
- [ ] –í—Å–µ async –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç await
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] Unit —Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- [ ] –ù–µ—Ç –ø—Ä—è–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—Å—è
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å

### –§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
```bash
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
black src/
isort src/

# –ü—Ä–æ–≤–µ—Ä–∫–∏
mypy src/
flake8 src/
pytest tests/ -v

# –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ - –∫–æ–º–º–∏—Ç!
git add .
git commit -m "feat(backend): –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏—á–∏"
```

---

## üö´ –ö–†–ê–°–ù–´–ï –§–õ–ê–ì–ò

**–°–¢–û–ü! –ù–ï –ö–û–ú–ú–ò–¢–¨, –µ—Å–ª–∏:**
- ‚ùå –ï—Å—Ç—å TODO/FIXME –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- ‚ùå –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç
- ‚ùå Mypy –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫–∏
- ‚ùå –ï—Å—Ç—å print() –æ—Ç–ª–∞–¥–∫–∞
- ‚ùå –•–∞—Ä–¥–∫–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤/–ø–∞—Ä–æ–ª–µ–π
- ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç type hints

---

**–ü–û–ú–ù–ò: –ü—Ä–æ—Å—Ç–æ—Ç–∞ –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ! –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω–∞ –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞.** 